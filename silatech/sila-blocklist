const { cmd } = require('../momy');

// Command ya kuona blocklist
cmd({
    pattern: "blocklist",
    alias: ["listblock", "blocks", "blocked"],
    desc: "View your blocked contacts list",
    category: "owner",
    react: "ğŸš«",
    fromMe: true
}, async (conn, mek, m, { reply }) => {
    try {
        await reply("*â³ Fetching blocked contacts...*");
        
        // Fetch blocklist from WhatsApp
        const blocklist = await conn.fetchBlocklist();
        
        if (!blocklist || blocklist.length === 0) {
            return reply("*âœ… You have no blocked contacts*");
        }
        
        let response = `â•­â”â”ã€ ğŸš« ğ™±ğ™»ğ™¾ğ™²ğ™ºğ™´ğ™³ ğ™²ğ™¾ğ™½ğšƒğ™°ğ™²ğšƒğš‚ ã€‘â”â”â”â•®
â”‚ ğŸ“Š ğšƒğš˜ğšğšŠğš•: *${blocklist.length}*
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯\n\n`;
        
        // Display blocked contacts with numbers
        blocklist.forEach((contact, index) => {
            const jid = contact.jid || contact;
            const number = jid.split('@')[0];
            const name = contact.notify || contact.name || `User ${index + 1}`;
            
            response += `â•­â”â”ã€ #${index + 1} ã€‘â”â”â”â”â”â”â”â”â•®
â”‚ ğŸ‘¤ ğ™½ğšŠğš–ğš: *${name}*
â”‚ ğŸ“ ğ™½ğšğš–ğš‹ğšğš›: *${number}*
â”‚ ğŸ†” ğ™¹ğ™¸ğ™³: ${jid}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯\n`;
        });
        
        response += `\nğŸ“ *ğ™²ğ™¾ğ™¼ğ™¼ğ™°ğ™½ğ™³ğš‚:*
â€¢ *${config.PREFIX}unblockall* - Unblock all contacts
â€¢ *${config.PREFIX}unblock @tag* - Unblock specific contact
â€¢ *${config.PREFIX}block @tag* - Block a contact\n\n> ğğ¨ğ°ğğ«ğ ğğ² ğ’ğ¢ğ¥ğš ğ“ğğœğ¡`;
        
        await reply(response);
        
    } catch (error) {
        console.error('Blocklist error:', error);
        reply("*âŒ Failed to fetch blocklist*");
    }
});

// Command ya kutoa block wote
cmd({
    pattern: "unblockall",
    alias: ["unblockall", "clearblocks"],
    desc: "Unblock all blocked contacts",
    category: "owner",
    react: "âœ…",
    fromMe: true
}, async (conn, mek, m, { reply }) => {
    try {
        await reply("*â³ Fetching blocked contacts...*");
        
        const blocklist = await conn.fetchBlocklist();
        
        if (!blocklist || blocklist.length === 0) {
            return reply("*âœ… You have no blocked contacts to unblock*");
        }
        
        await reply(`*â³ Unblocking ${blocklist.length} contacts...*`);
        
        let successCount = 0;
        let failCount = 0;
        
        // Unblock each contact
        for (const contact of blocklist) {
            try {
                const jid = contact.jid || contact;
                await conn.updateBlockStatus(jid, 'unblock');
                successCount++;
                
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 500));
            } catch (err) {
                console.error(`Failed to unblock ${contact}:`, err.message);
                failCount++;
            }
        }
        
        const result = `â•­â”â”ã€ âœ… ğš„ğ™½ğ™±ğ™»ğ™¾ğ™²ğ™º ğšğ™´ğš‚ğš„ğ™»ğšƒğš‚ ã€‘â”â”â”â•®
â”‚ ğŸ“Š ğšƒğš˜ğšğšŠğš•: *${blocklist.length}*
â”‚ âœ… ğš‚ğšğšŒğšŒğšğšœğšœ: *${successCount}*
â”‚ âŒ ğ™µğšŠğš’ğš•ğšğš: *${failCount}*
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯\n\n> ğğ¨ğ°ğğ«ğ ğğ² ğ’ğ¢ğ¥ğš ğ“ğğœğ¡`;
        
        await reply(result);
        
    } catch (error) {
        console.error('Unblockall error:', error);
        reply("*âŒ Failed to unblock contacts*");
    }
});

// Command ya kutoa block mmoja mmoja (kwa mention)
cmd({
    pattern: "unblock",
    alias: ["removeblock", "ublock"],
    desc: "Unblock a specific contact",
    category: "owner",
    react: "ğŸ”“",
    fromMe: true
}, async (conn, mek, m, { from, reply, text, mentionedJid }) => {
    try {
        // Check if there's a mention
        if (!mentionedJid || mentionedJid.length === 0) {
            return reply(`*ğŸ“ ğš„ğš‚ğ™°ğ™¶ğ™´:*
â€¢ ${config.PREFIX}unblock @mention
â€¢ ${config.PREFIX}unblock 2557xxxxxxxx\n\nğš„ğš—ğš‹ğš•ğš˜ğšŒğš” ğš‹ğš¢ ğš–ğšğš—ğšğš’ğš˜ğš—ğš’ğš—ğš ğš˜ğš› ğš™ğš›ğš˜ğšŸğš’ğšğš’ğš—ğš ğš—ğšğš–ğš‹ğšğš›`);
        }
        
        const targetJid = mentionedJid[0];
        
        // Check if it's a valid JID
        if (!targetJid.includes('@')) {
            return reply("*âŒ Invalid user mentioned*");
        }
        
        await reply(`*â³ Checking if ${targetJid.split('@')[0]} is blocked...*`);
        
        // First check if user is actually blocked
        const blocklist = await conn.fetchBlocklist();
        const isBlocked = blocklist.some(contact => {
            const contactJid = contact.jid || contact;
            return contactJid === targetJid;
        });
        
        if (!isBlocked) {
            return reply(`*â„¹ï¸ ${targetJid.split('@')[0]} is not blocked*`);
        }
        
        // Unblock the user
        await conn.updateBlockStatus(targetJid, 'unblock');
        
        const successMessage = `â•­â”â”ã€ âœ… ğš„ğ™½ğ™±ğ™»ğ™¾ğ™²ğ™ºğ™´ğ™³ ã€‘â”â”â”â”â”â”â•®
â”‚ ğŸ”“ ğš„ğšœğšğš›: @${targetJid.split('@')[0]}
â”‚ ğŸ“ ğ™½ğšğš–ğš‹ğšğš›: ${targetJid.split('@')[0]}
â”‚ ğŸ• ğšƒğš’ğš–ğš: ${new Date().toLocaleTimeString()}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯\n\n> ğğ¨ğ°ğğ«ğ ğğ² ğ’ğ¢ğ¥ğš ğ“ğğœğ¡`;
        
        await reply(successMessage, { mentions: [targetJid] });
        
    } catch (error) {
        console.error('Unblock error:', error);
        reply("*âŒ Failed to unblock user*");
    }
});

// Command ya kuweka block (kwa mention)
cmd({
    pattern: "block",
    alias: ["addblock", "blockuser"],
    desc: "Block a specific contact",
    category: "owner",
    react: "ğŸš«",
    fromMe: true
}, async (conn, mek, m, { from, reply, text, mentionedJid }) => {
    try {
        // Check if there's a mention or number provided
        if ((!mentionedJid || mentionedJid.length === 0) && !text) {
            return reply(`*ğŸ“ ğš„ğš‚ğ™°ğ™¶ğ™´:*
â€¢ ${config.PREFIX}block @mention
â€¢ ${config.PREFIX}block 2557xxxxxxxx\n\nğ™±ğš•ğš˜ğšŒğš” ğš‹ğš¢ ğš–ğšğš—ğšğš’ğš˜ğš—ğš’ğš—ğš ğš˜ğš› ğš™ğš›ğš˜ğšŸğš’ğšğš’ğš—ğš ğš—ğšğš–ğš‹ğšğš›`);
        }
        
        let targetJid;
        
        if (mentionedJid && mentionedJid.length > 0) {
            // Use mentioned user
            targetJid = mentionedJid[0];
        } else if (text) {
            // Use provided number
            const number = text.replace(/[^0-9]/g, '');
            if (number.length < 9) {
                return reply("*âŒ Invalid phone number*");
            }
            targetJid = `${number}@s.whatsapp.net`;
        }
        
        if (!targetJid.includes('@')) {
            return reply("*âŒ Invalid user/number*");
        }
        
        await reply(`*â³ Blocking ${targetJid.split('@')[0]}...*`);
        
        // First check if already blocked
        const blocklist = await conn.fetchBlocklist();
        const isAlreadyBlocked = blocklist.some(contact => {
            const contactJid = contact.jid || contact;
            return contactJid === targetJid;
        });
        
        if (isAlreadyBlocked) {
            return reply(`*â„¹ï¸ ${targetJid.split('@')[0]} is already blocked*`);
        }
        
        // Block the user
        await conn.updateBlockStatus(targetJid, 'block');
        
        const successMessage = `â•­â”â”ã€ ğŸš« ğ™±ğ™»ğ™¾ğ™²ğ™ºğ™´ğ™³ ã€‘â”â”â”â”â”â”â•®
â”‚ ğŸš« ğš„ğšœğšğš›: @${targetJid.split('@')[0]}
â”‚ ğŸ“ ğ™½ğšğš–ğš‹ğšğš›: ${targetJid.split('@')[0]}
â”‚ ğŸ• ğšƒğš’ğš–ğš: ${new Date().toLocaleTimeString()}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯\n\n> ğğ¨ğ°ğğ«ğ ğğ² ğ’ğ¢ğ¥ğš ğ“ğğœğ¡`;
        
        await reply(successMessage, { mentions: [targetJid] });
        
    } catch (error) {
        console.error('Block error:', error);
        reply("*âŒ Failed to block user*");
    }
});

// Command ya kucheck kama user specific ameblock
cmd({
    pattern: "checkblock",
    alias: ["isblocked", "blockcheck"],
    desc: "Check if a user is blocked",
    category: "owner",
    react: "ğŸ”",
    fromMe: true
}, async (conn, mek, m, { from, reply, text, mentionedJid }) => {
    try {
        if ((!mentionedJid || mentionedJid.length === 0) && !text) {
            return reply(`*ğŸ“ ğš„ğš‚ğ™°ğ™¶ğ™´:*
â€¢ ${config.PREFIX}checkblock @mention
â€¢ ${config.PREFIX}checkblock 2557xxxxxxxx`);
        }
        
        let targetJid;
        
        if (mentionedJid && mentionedJid.length > 0) {
            targetJid = mentionedJid[0];
        } else if (text) {
            const number = text.replace(/[^0-9]/g, '');
            if (number.length < 9) {
                return reply("*âŒ Invalid phone number*");
            }
            targetJid = `${number}@s.whatsapp.net`;
        }
        
        await reply(`*â³ Checking block status...*`);
        
        const blocklist = await conn.fetchBlocklist();
        const isBlocked = blocklist.some(contact => {
            const contactJid = contact.jid || contact;
            return contactJid === targetJid;
        });
        
        const result = `â•­â”â”ã€ ğŸ” ğ™±ğ™»ğ™¾ğ™²ğ™º ğš‚ğšƒğ™°ğšƒğš„ğš‚ ã€‘â”â”â”â•®
â”‚ ğŸ‘¤ ğš„ğšœğšğš›: @${targetJid.split('@')[0]}
â”‚ ğŸ“ ğ™½ğšğš–ğš‹ğšğš›: ${targetJid.split('@')[0]}
â”‚ ğŸš« ğš‚ğšğšŠğšğšğšœ: *${isBlocked ? 'ğ™±ğ™»ğ™¾ğ™²ğ™ºğ™´ğ™³ ğŸ”´' : 'ğ™½ğ™¾ğšƒ ğ™±ğ™»ğ™¾ğ™²ğ™ºğ™´ğ™³ ğŸŸ¢'}*
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯\n\n> ğğ¨ğ°ğğ«ğ ğğ² ğ’ğ¢ğ¥ğš ğ“ğğœğ¡`;
        
        await reply(result, { mentions: [targetJid] });
        
    } catch (error) {
        console.error('Checkblock error:', error);
        reply("*âŒ Failed to check block status*");
    }
});

// Add config to the file
const config = require('../config');
